name: release

on:
  workflow_dispatch: {}

permissions:
  contents: write
  id-token: write
  packages: write

env:
  PROJECT_NAME: ghoten
  REGISTRY: ghcr.io/vmvarela/ghoten

jobs:
  # ─────────────────────────────────────────────
  # 1. Semantic Release — determines next version
  # ─────────────────────────────────────────────
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.semantic.outputs.version }}
      major: ${{ steps.version.outputs.major }}
      minor: ${{ steps.version.outputs.minor }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Run go-semantic-release
        id: semantic
        uses: go-semantic-release/action@2e9dc4247a6004f8377781bef4cb9dad273a741f # v1.24.1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          allow-initial-development-versions: true
          force-bump-patch-version: true
          changelog-generator-opt: "emojis=true"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse version components
        id: version
        if: steps.semantic.outputs.version != ''
        run: |
          VERSION="${{ steps.semantic.outputs.version }}"
          echo "major=${VERSION%%.*}" >> "$GITHUB_OUTPUT"
          echo "minor=${VERSION%.*}" >> "$GITHUB_OUTPUT"

  # ─────────────────────────────────────────────
  # 2. Build — one parallel job per OS/arch combo
  # ─────────────────────────────────────────────
  build:
    name: Build ${{ matrix.goos }}/${{ matrix.goarch }}
    needs: release
    if: needs.release.outputs.version != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - { goos: linux,   goarch: "386" }
          - { goos: linux,   goarch: amd64 }
          - { goos: linux,   goarch: arm }
          - { goos: linux,   goarch: arm64 }
          - { goos: darwin,  goarch: amd64 }
          - { goos: darwin,  goarch: arm64 }
          - { goos: windows, goarch: "386" }
          - { goos: windows, goarch: amd64 }
          - { goos: freebsd, goarch: "386" }
          - { goos: freebsd, goarch: amd64 }
          - { goos: freebsd, goarch: arm }
          - { goos: openbsd, goarch: "386" }
          - { goos: openbsd, goarch: amd64 }
          - { goos: solaris,  goarch: amd64 }
    env:
      CGO_ENABLED: "0"
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: refs/tags/v${{ needs.release.outputs.version }}

      - name: Set up Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod

      - name: Build binary
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          EXT=""; [[ "${GOOS}" == "windows" ]] && EXT=".exe"
          go build -mod=readonly -trimpath \
            -ldflags "-s -w -X 'github.com/opentofu/opentofu/version.dev=no' -X 'github.com/opentofu/opentofu/version.rawVersion=${VERSION}'" \
            -o "ghoten${EXT}" ./cmd/tofu

      - name: Create archives
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          NAME="${{ env.PROJECT_NAME }}_${VERSION}_${{ matrix.goos }}_${{ matrix.goarch }}"
          mkdir -p dist
          if [[ "${GOOS}" == "windows" ]]; then
            tar czf "dist/${NAME}.tar.gz" ghoten.exe
            zip "dist/${NAME}.zip" ghoten.exe
          else
            tar czf "dist/${NAME}.tar.gz" ghoten
            zip "dist/${NAME}.zip" ghoten
          fi

      - name: Upload archives
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: archive-${{ matrix.goos }}-${{ matrix.goarch }}
          path: dist/*
          retention-days: 1

      - name: Upload binary (for Docker)
        if: matrix.goos == 'linux'
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08 # v4.6.0
        with:
          name: binary-linux-${{ matrix.goarch }}
          path: ghoten
          retention-days: 1

  # ───────────────────────────────────────────────────
  # 3. Docker — multi-platform images (full + minimal)
  # ───────────────────────────────────────────────────
  docker:
    name: Docker (${{ matrix.variant }})
    needs: [release, build]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - { variant: full,    dockerfile: Dockerfile,         suffix: "",         latest_tag: latest }
          - { variant: minimal, dockerfile: Dockerfile.minimal, suffix: "-minimal", latest_tag: minimal }
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: refs/tags/v${{ needs.release.outputs.version }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@53851d14592bedcffcf25ea515637cff71ef929a # v3.3.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@6524bf65af31da8d45b59e8c27de4bd072b392f5 # v3.8.0

      - name: Login to GHCR
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Download Linux binaries
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          pattern: binary-linux-*
          path: binaries

      - name: Prepare Docker context
        run: |
          for arch in amd64 arm64 386; do
            mkdir -p "linux/${arch}"
            cp "binaries/binary-linux-${arch}/ghoten" "linux/${arch}/ghoten"
            chmod +x "linux/${arch}/ghoten"
          done
          # Docker sets TARGETPLATFORM=linux/arm/v7 for --platform linux/arm
          mkdir -p linux/arm/v7
          cp "binaries/binary-linux-arm/ghoten" linux/arm/ghoten
          cp "binaries/binary-linux-arm/ghoten" linux/arm/v7/ghoten
          chmod +x linux/arm/ghoten linux/arm/v7/ghoten

      - name: Build and push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          platforms: linux/amd64,linux/arm64,linux/arm,linux/386
          tags: |
            ${{ env.REGISTRY }}:${{ needs.release.outputs.version }}${{ matrix.suffix }}
            ${{ env.REGISTRY }}:${{ needs.release.outputs.minor }}${{ matrix.suffix }}
            ${{ env.REGISTRY }}:${{ needs.release.outputs.major }}${{ matrix.suffix }}
            ${{ env.REGISTRY }}:${{ matrix.latest_tag }}
          labels: |
            org.opencontainers.image.title=${{ env.PROJECT_NAME }}
            org.opencontainers.image.vendor=Ghoten
            org.opencontainers.image.description=Ghoten ${{ needs.release.outputs.version }}${{ matrix.suffix != '' && ' (minimal)' || '' }}
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.documentation=https://github.com/${{ github.repository }}/blob/main/README.md
            org.opencontainers.image.licenses=MPL-2.0
            org.opencontainers.image.version=${{ needs.release.outputs.version }}

      - name: Install cosign
        uses: sigstore/cosign-installer@7e8b541eb2e61bf99390e1afd4be13a184e9ebc5 # v3.10.1

      - name: Sign Docker images
        run: |
          TAGS=(
            "${{ needs.release.outputs.version }}${{ matrix.suffix }}"
            "${{ needs.release.outputs.minor }}${{ matrix.suffix }}"
            "${{ needs.release.outputs.major }}${{ matrix.suffix }}"
            "${{ matrix.latest_tag }}"
          )
          for tag in "${TAGS[@]}"; do
            cosign sign --oidc-issuer=https://token.actions.githubusercontent.com \
              "${{ env.REGISTRY }}:${tag}" --yes
          done

  # ──────────────────────────────────────────
  # 4. Publish — checksums, signing, upload
  # ──────────────────────────────────────────
  publish:
    name: Checksums & Sign
    needs: [release, build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all archives
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          pattern: archive-*
          path: dist
          merge-multiple: true

      - name: Install cosign
        uses: sigstore/cosign-installer@7e8b541eb2e61bf99390e1afd4be13a184e9ebc5 # v3.10.1

      - name: Create checksums
        working-directory: dist
        run: sha256sum * > "${{ env.PROJECT_NAME }}_${{ needs.release.outputs.version }}_SHA256SUMS"

      - name: Sign all artifacts
        working-directory: dist
        run: |
          for f in *; do
            cosign sign-blob \
              --oidc-issuer=https://token.actions.githubusercontent.com \
              --output-certificate="${f}.pem" \
              --output-signature="${f}.sig" \
              "${f}" --yes
          done

      - name: Upload to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "v${{ needs.release.outputs.version }}" dist/* \
            --repo "${{ github.repository }}" --clobber
